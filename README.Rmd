---
output: 
  github_document
---

# Flight Analysis - R Package

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

An R package for analyzing, forecasting, and collecting flight data and prices from Google Flights. 

**Credits:** This package is an R implementation inspired by the original Python package [google-flight-analysis](https://github.com/celebi-pkg/flight-analysis) by Kaya Celebi.

## Features

- Detailed scraping and querying tools for Google Flights using chromote
- Support for multiple trip types: one-way, round-trip, chain-trip, and perfect-chain
- Driver-free web scraping using Chrome DevTools Protocol
- **NEW:** Flexible date search across multiple airports and date ranges
- **NEW:** Summary tables showing prices by city and date with average calculations
- **NEW:** Automatic identification of cheapest travel dates

## Installation

You can install the development version of flightanalysis from GitHub:

```{r eval=FALSE}
# Install devtools if you haven't already
# install.packages("devtools")

# Install flightanalysis
devtools::install_github("rempsyc/flightanalysis")
```

## Usage

### Loading the Package

```{r eval=TRUE}
library(flightanalysis)
```

### Creating Flight Queries

The main scraping function that makes up the backbone of most functionalities is `Scrape()`. It serves as a data object, preserving the flight information as well as meta-data from your query.

#### One-Way Trip

```{r eval=TRUE}
# Create a one-way flight query
scrape <- Scrape("JFK", "IST", "2025-07-20")
scrape
```

#### Round-Trip

```{r eval=TRUE}
# Create a round-trip flight query
scrape <- Scrape("JFK", "IST", "2025-07-20", "2025-08-20")
scrape
```

#### Chain-Trip

Chain-trips are defined as a sequence of one-way flights that have no direct relation to each other, other than being in chronological order.

```{r eval=TRUE}
# Chain-trip format: origin, dest, date, origin, dest, date, ...
scrape <- Scrape("JFK", "IST", "2025-08-20", "RDU", "LGA", "2025-12-25", "EWR", "SFO", "2026-01-20")
scrape
```

#### Perfect-Chain

Perfect-chains are defined as a sequence of one-way flights such that the destination of the previous flight is the origin of the next, and the origin of the chain is the final destination (a cycle).

```{r eval=TRUE}
# Perfect-chain format: origin, date, origin, date, ..., first_origin
scrape <- Scrape("JFK", "2025-09-20", "IST", "2025-09-25", "CDG", "2025-10-10", "LHR", "2025-11-01", "JFK")
scrape
```

### Scraping Data

The package now includes full web scraping functionality using **chromote**!

**Why chromote?**
- ✅ No external driver files needed (uses Chrome DevTools Protocol directly)
- ✅ More reliable - no driver version mismatches or port conflicts
- ✅ Simpler installation - just install the R package
- ✅ Works on all platforms (Windows, macOS, Linux)
- ✅ Fully headless by default

Then scrape flight data from Google Flights:

```{r eval=TRUE}
# Create a query
scrape <- Scrape("JFK", "IST", "2025-12-20", "2026-01-05")

# Scrape the data (runs in headless mode by default)
scrape <- ScrapeObjects(scrape)

# View the scraped data
head(scrape$data) |>
  knitr::kable()
```

The `ScrapeObjects()` function will:
1. **Run pre-flight checks** - Verify Chrome installation and internet connectivity
2. **Automatically connect to Chrome** - Using Chrome DevTools Protocol (no drivers!)
3. **Navigate to Google Flights URLs** - With proper wait times for page loading
4. **Extract flight information** - Parse prices, times, airlines, stops, and emissions
5. **Store results** - Save data in the Scrape object's `data` field
6. **Handle errors gracefully** - Provide detailed troubleshooting tips if issues occur

**Advantages over RSelenium:**

chromote eliminates common RSelenium issues:
- ❌ No more "invalid assignment for reference class field 'port'" errors
- ❌ No more driver download/installation problems
- ❌ No more version compatibility issues
- ❌ No more port conflicts
- ✅ Just install chromote and it works!

### Working with Flight Objects

```{r eval=TRUE}
# Create Flight objects
flight1 <- Flight("2025-12-25", "JFKIST", "9:00AM", "5:00PM", 
                  "8 hr 0 min", "Nonstop", "150 kg CO2", "10% emissions", "$450")
flight2 <- Flight("2025-12-26", "ISTCDG", "10:00AM", "2:00PM", 
                  "4 hr 0 min", "Nonstop", "100 kg CO2", "5% emissions", "$300")
flight3 <- Flight("2025-12-27", "CDGJFK", "11:00AM", "1:00PM", 
                  "8 hr 0 min", "1 stop", "200 kg CO2", "15% emissions", "$500")

# Convert multiple flights to a data frame
flights <- list(flight1, flight2, flight3)
df <- flights_to_dataframe(flights)
df
```

## Flexible Date Search (NEW!)

The package now supports flexible date search across multiple airports and dates, making it easy to find the cheapest flights when you have flexibility in your travel plans.

### Basic Workflow

```{r eval=TRUE}
# Step 1: Create Scrape objects for all routes and dates
scrapes <- fa_create_date_range_scrape(
  origin = c("BOM", "DEL", "VNS", "PAT"),
  dest = "JFK",
  date_min = "2025-12-28",
  date_max = "2026-01-03"
)

# Step 2: Scrape each origin
scraped <- ScrapeObjects(scrapes)

# Step 3: Analyze directly with list of Scrape objects

# Create wide summary table (City × Date with Average Price)
summary_table <- fa_flex_table(scraped)
summary_table |>
  knitr::kable()

# Find the top 10 cheapest dates
best_dates <- fa_best_dates(scraped, n = 10, by = "mean")
best_dates |>
  knitr::kable()
```

**Key Features:**
- **Per-origin Scrape objects**: Each origin gets its own chain-trip Scrape object (required due to strict date ordering in chain-trips)
- **Simple workflow**: (1) Create list of Scrape objects with `fa_create_date_range_scrape()`, (2) Scrape each with `ScrapeObjects()`, (3) Pass directly to analysis functions
- **Direct Scrape object support**: `fa_flex_table()` and `fa_best_dates()` accept lists of Scrape objects directly - no manual data processing needed!
- Search multiple origin airports and dates efficiently
- Automatically leverages existing chain-trip functionality
- Automatic filtering of placeholder rows
- Create wide summary tables for easy price comparison
- Identify cheapest travel dates automatically
- Optional currency formatting with the `scales` package

### Single Origin Example

```{r eval=TRUE}
# For single origin, returns one Scrape object (not a list)
scrape <- fa_create_date_range_scrape(
  origin = "BOM",
  dest = "JFK",
  date_min = "2025-12-18",
  date_max = "2026-01-05"
)

# Scrape directly
scraped <- ScrapeObjects(scrape, verbose = TRUE)

# Analyze with helper functions
summary_table <- fa_flex_table(scraped)
summary_table |>
  knitr::kable()

best_dates <- fa_best_dates(scraped, n = 5)
best_dates |>
  knitr::kable()
```

### Using fa_flex_table()

The `fa_flex_table()` function creates a wide summary table showing prices by city/airport and date:

```{r eval=TRUE}
# Create summary table from scraped data
summary_table <- fa_flex_table(scraped)

# Optional: customize the output
summary_table <- fa_flex_table(
  scraped,
  include_comment = TRUE,     # Include comment column if available
  currency_symbol = "$",      # Currency symbol for formatting
  round_prices = TRUE         # Round prices to nearest integer
)
```

**Output format:**
- Rows: One per city/airport combination
- Columns: One per date, plus an Average_Price column
- Values: Minimum (cheapest) price for each date
- Automatically filters out placeholder rows (e.g., "Price graph")

### Using fa_best_dates()

The `fa_best_dates()` function identifies the cheapest travel dates:

```{r eval=TRUE}
# Find the 10 cheapest dates by mean price
best_dates <- fa_best_dates(scraped, n = 10, by = "mean")
best_dates

# Alternative aggregation methods
best_dates_median <- fa_best_dates(scraped, n = 5, by = "median")
best_dates_median

best_dates_min <- fa_best_dates(scraped, n = 5, by = "min")
best_dates_min
```

**Parameters:**
- `n`: Number of best dates to return (default: 10)
- `by`: Aggregation method - "mean" (average), "median", or "min" (default: "mean")

**Output:**
- `Date`: The date
- `Price`: Aggregated price (mean/median/min depending on `by` parameter)
- `N_Routes`: Number of routes with data for that date

## Trip Types

The package supports multiple trip types:

- **One-way**: Single flight from origin to destination
- **Round-trip**: Flight to destination and return
- **Chain-trip**: Sequence of unrelated one-way flights in chronological order
- **Perfect-chain**: Sequence where each destination becomes the next origin, forming a cycle

## Updates & New Features

**November 2025**: 
- ✅ Full R package implementation with equivalent functionality to the Python version!
- ✅ Complete web scraping with **chromote** - driver-free browser automation
- ✅ No more driver installation/compatibility issues - uses Chrome DevTools Protocol directly
- ✅ Headless mode support for server environments
- ✅ **NEW:** Flexible date search with `fa_create_date_range_scrape()` for searching multiple airports and dates
- ✅ **NEW:** Wide summary tables with `fa_flex_table()` for easy price comparison
- ✅ **NEW:** Best date identification with `fa_best_dates()` for finding cheapest travel dates

This R package maintains the core functionality of the Python version but with R-specific implementations:

- Uses S3 classes instead of Python classes
- chromote instead of Python's selenium
- Base R data frames instead of pandas
- Native R date/time handling instead of Python's datetime

## Development Status

This is a complete R port of the Python package. The core data structures and API are fully implemented. Web scraping functionality uses chromote (Chrome DevTools Protocol), which provides driver-free browser automation without the configuration overhead of RSelenium.

## License

MIT License

## Original Python Package

This is a port of the [google-flight-analysis](https://github.com/celebi-pkg/flight-analysis) Python package by Kaya Celebi.

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.
